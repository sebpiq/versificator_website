<!DOCTYPE html>
<html>
    <head>
        <title>Versificator</title>
        <script src="js/lib/jquery-1.8.3.min.js"></script>
        <script src="js/lib/processing-1.4.1.min.js"></script>

        <link href="css/versificator.less" rel="stylesheet/less" type="text/css" />
        <script src="js/lib/less-1.3.1.min.js"></script>
    </head>

    <body>
        <audio autoplay="autoplay" src="http://versificator.fm:8000/versificator.ogg"></audio>
        <canvas id="sketch"></canvas>
        <script>
            var pickImageUrl = function() {
                return 'images/' + (1 + Math.floor(Math.random() * 15)) + '.png';
            };

            var sketch = new Processing(document.getElementById('sketch')),
                TILT_NUM = 5, // number of times image tilt between 2 beats
                TILT_MAX = Math.PI / 6,
                TILT_STEP = TILT_MAX * 0.05;

            var ImageAttrs = {
                x: 500,
                y: 500,
                angle: 0,
                sketch: sketch,

                tilt: function() {
                    this.angle = (Math.random() * TILT_STEP * 2) - TILT_STEP;
                    this.angle = Math.min(TILT_MAX, this.angle);
                    this.angle = Math.max(-TILT_MAX, this.angle);
                },

                redraw: function() {
                    this.sketch.pushMatrix();
                    this.sketch.translate(this.x, this.y);
                    this.sketch.rotate(this.angle);
                    this.sketch.image(this, - this.width / 2, - this.height / 2);
                    this.sketch.popMatrix();
                }
            };

            $.extend(sketch, {
                images: [],

                setup: function() {
                    this.size(window.innerWidth, window.innerHeight);
                    this.background(255);
                    this.setTempo(60);
                },
        
                draw: function() {
                    this.background(255);
                    var i, image;
                    for (i = 0; image = this.images[i]; i++) {
                        image.tilt();
                        image.redraw();
                    }
                    if (this.frameCount % TILT_NUM === 0) this.getNewImage();
                },

                getNewImage: function() {
                    var newImg = this.requestImage(pickImageUrl());
                    $.extend(newImg, ImageAttrs, {x: Math.random() * window.innerWidth, y: Math.random() * window.innerHeight});
                    this.images.push(newImg);
                },

                setTempo: function(bpm) {
                    console.log(bpm * TILT_NUM / 60);
                    this.frameRate(bpm * TILT_NUM / 60);
                }
            });
            sketch.setup();
        </script>
    </body>

</html>
