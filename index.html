<!DOCTYPE html>
<html>
    <head>
        <title>Versificator</title>
        <script src="js/lib/jquery-1.8.3.min.js"></script>
        <script src="js/lib/processing-1.4.1.min.js"></script>
        <script src="js/utils.js"></script>

        <link href="css/versificator.less" rel="stylesheet/less" type="text/css" />
        <script src="js/lib/less-1.3.1.min.js"></script>
    </head>

    <body>
        <audio autoplay="autoplay" src="http://versificator.fm:8000/versificator.ogg"></audio>
        <!--<button onclick="sketch.noLoop();">stop</button>
        <button onclick="sketch.loop();">start</button>-->
        <canvas id="sketch"></canvas>
        <script>
            var getImageUrls = function() {
                var urls = [], i;
                for (i = 1; i < IMG_BANK_SIZE + 1; i++) urls.push('images/' + i + '.png');
                return urls;           
            }

            var randomizeArray = function (myArray) {
                var i = myArray.length;
                if (i === 0) return false;
                while (--i) {
                    var j = Math.floor(Math.random() * (i + 1));
                    var tempi = myArray[i];
                    var tempj = myArray[j];
                    myArray[i] = tempj;
                    myArray[j] = tempi;
                }
            };

            var sketch = new Processing(document.getElementById('sketch')),
                ww = window.innerWidth, wh = window.innerHeight,
                last_position = {x: ww / 2, y: wh / 2},
                TILT_NUM = 5,                   // num. of times image tilt between 2 beats
                TILT_MAX = Math.PI / 6,
                TILT_STEP = TILT_MAX * 0.03,
                MOVE_X_STEP = ww * 0.5,
                MOVE_Y_STEP = wh * 0.5,
                IMG_BANK_SIZE = 38,
                IMG_MAX = 40;                   // num. images displayed at the same time

            var ImageMixin = {
                x: 0,
                y: 0,
                angle: 0,
                scale: 0.5,
                sketch: sketch,

                setPosition: function(x, y) {
                    this.x = x; this.y = y;
                    this.vertices = this._getVertices();
                },

                tilt: function() {
                    this.angle = (Math.random() * TILT_STEP * 2) - TILT_STEP;
                    this.angle = Math.min(TILT_MAX, this.angle);
                    this.angle = Math.max(-TILT_MAX, this.angle);
                },

                redraw: function() {
                    this.sketch.pushMatrix();
                    this.sketch.translate(this.x, this.y);
                    this.sketch.rotate(this.angle);
                    this.sketch.image(this,
                        -this.width * this.scale / 2, -this.height * this.scale / 2,
                        this.width * this.scale, this.height * this.scale
                    );
                    this.sketch.popMatrix();
                },

                _getVertices: function() {
                    var rw = this.width * 0.3, rh = this.height * 0.3;
                    return [
                        // 4 corners
                        {x: this.x - rw / 2, y: this.y - rh / 2},
                        {x: this.x - rw / 2, y: this.y + rh / 2},
                        {x: this.x + rw / 2, y: this.y + rh / 2},
                        {x: this.x + rw / 2, y: this.y - rh / 2},
                        // center
                        {x: this.x, y: this.y},
                        // interpolated
                        {x: this.x - rw, y: this.y},
                        {x: this.x + rw, y: this.y},
                        {x: this.x, y: this.y + rh},
                        {x: this.x, y: this.y - rh},
                    ]
                }

            };

            $.extend(sketch, {
                imageBank: [],      // images available
                imagesShuffled: [], // list of images for random display
                images: [],         // images currently on display
                vertices: [],       // vertices of images currently on display

                setup: function() {
                    var urls = getImageUrls(), i, img;
                    for (i = 0; i < urls.length; i++) {
                        img = this.requestImage(urls[i]);
                        $.extend(img, ImageMixin);
                        this.imageBank.push(img);
                    }
                    this.size(ww, wh);
                    this.background(255);
                    this.setTempo(60);
                    this.stroke(200);
                },
        
                draw: function() {
                    var loaded = true, i;
                    for (i = 0; i < this.imageBank.length; i++) {
                        if (this.imageBank[i].width === 0) loaded = false;
                    }
                    if (loaded) {
                        console.log('all images loaded');
                        this.draw = this.drawNormal;
                    }
                },

                drawNormal: function() {
                    this.background(255);
                    if (this.frameCount % TILT_NUM === 0) this.getNewImage();

                    var triangles = alphaShapes(this.vertices, 200),
                        i, length, t, image;
                    for (i = 0, length = triangles.length; i < length; i++) {
                        t = triangles[i];
                        this.triangle(t.a.x, t.a.y, t.b.x, t.b.y, t.c.x, t.c.y);
                    }
                    for (i = 0; image = this.images[i]; i++) {
                        image.tilt();
                        image.redraw();
                    }
                },

                getNewImage: function() {
                    // Fill-up `imagesShuffled` if empty
                    if (this.imagesShuffled.length === 0) {
                        this.imagesShuffled = this.imageBank.slice(0);
                        randomizeArray(this.imagesShuffled);
                    }

                    // Calculate position for the new image
                    last_position.x += Math.random() * MOVE_X_STEP - MOVE_X_STEP / 2;
                    last_position.x = Math.min(last_position.x, ww - 200);
                    last_position.x = Math.max(last_position.x, 200);
                    last_position.y += Math.random() * MOVE_Y_STEP - MOVE_Y_STEP / 2;
                    last_position.y = Math.min(last_position.y, wh - 100);
                    last_position.y = Math.max(last_position.y, 100);

                    // Get the new image, add it to the list, add its vertices,
                    // remove oldest image if necessary.
                    var newImg = this.imagesShuffled.pop();
                    newImg.setPosition(last_position.x, last_position.y);
                    this.images.push(newImg);
                    this.vertices = this.vertices.concat(newImg.vertices);
                    if (this.images.length > IMG_MAX) {
                        var poppedImg = this.images.shift();
                        this.vertices.splice(0, poppedImg.vertices.length);
                    }
                },

                setTempo: function(bpm) {
                    this.frameRate(bpm * TILT_NUM / 60);
                }
            });
            sketch.setup();
        </script>
    </body>

</html>
