<!DOCTYPE html>
<html>
    <head>
        <title>Versificator</title>
        <script src="js/lib/jquery-1.8.3.min.js"></script>
        <script src="js/lib/processing-1.4.1.min.js"></script>

        <link href="css/versificator.less" rel="stylesheet/less" type="text/css" />
        <script src="js/lib/less-1.3.1.min.js"></script>
    </head>

    <body>
        <audio autoplay="autoplay" src="http://versificator.fm:8000/versificator.ogg"></audio>
        <canvas id="sketch"></canvas>
        <script>
            var pickImageUrl = function() {
                if (_imageInds.length === 0) {
                    for (var i = 1; i < IMG_BANK_SIZE + 1; i++) _imageInds.push(i);
                    randomizeArray(_imageInds);
                } 
                return 'images/' + _imageInds.pop() + '.png';
            }, _imageInds = [];

            var randomizeArray = function (myArray) {
                var i = myArray.length;
                if (i === 0) return false;
                while (--i) {
                    var j = Math.floor(Math.random() * (i + 1));
                    var tempi = myArray[i];
                    var tempj = myArray[j];
                    myArray[i] = tempj;
                    myArray[j] = tempi;
                }
            };

            var sketch = new Processing(document.getElementById('sketch')),
                ww = window.innerWidth, wh = window.innerHeight,
                last_position = {x: ww / 2, y: wh / 2},
                TILT_NUM = 5, // number of times image tilt between 2 beats
                TILT_MAX = Math.PI / 6,
                TILT_STEP = TILT_MAX * 0.05,
                IMG_BANK_SIZE = 18,
                IMG_STEP = 0.5,
                IMG_MAX = 50;

            var ImageAttrs = {
                x: 500,
                y: 500,
                angle: 0,
                sketch: sketch,

                tilt: function() {
                    this.angle = (Math.random() * TILT_STEP * 2) - TILT_STEP;
                    this.angle = Math.min(TILT_MAX, this.angle);
                    this.angle = Math.max(-TILT_MAX, this.angle);
                },

                redraw: function() {
                    this.sketch.pushMatrix();
                    this.sketch.translate(this.x, this.y);
                    this.sketch.rotate(this.angle);
                    this.sketch.image(this, - this.width / 2, - this.height / 2, this.width / 2, this.height / 2);
                    this.sketch.popMatrix();
                }
            };

            $.extend(sketch, {
                images: [],

                setup: function() {
                    this.size(ww, wh);
                    this.background(255);
                    this.setTempo(60);
                },
        
                draw: function() {
                    this.background(255);
                    var i, image;
                    for (i = 0; image = this.images[i]; i++) {
                        image.tilt();
                        image.redraw();
                    }
                    if (this.frameCount % TILT_NUM === 0) this.getNewImage();
                },

                getNewImage: function() {
                    var newImg = this.requestImage(pickImageUrl());
                    last_position.x += Math.random() * ww * IMG_STEP - ww * IMG_STEP / 2;
                    last_position.x = Math.min(last_position.x, ww);
                    last_position.x = Math.max(last_position.x, 0);
                    last_position.y += Math.random() * wh * IMG_STEP - wh * IMG_STEP / 2;
                    last_position.y = Math.min(last_position.y, wh);
                    last_position.y = Math.max(last_position.y, 0);

                    $.extend(newImg, ImageAttrs, {
                        x: last_position.x,
                        y: last_position.y
                    });
                    this.images.push(newImg);
                    if (this.images.length > IMG_MAX) this.images.splice(0, 1);
                },

                setTempo: function(bpm) {
                    this.frameRate(bpm * TILT_NUM / 60);
                }
            });
            sketch.setup();
        </script>
    </body>

</html>
